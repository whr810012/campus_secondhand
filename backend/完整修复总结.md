# JSONååºåˆ—åŒ–é—®é¢˜å®Œæ•´ä¿®å¤æ€»ç»“

## é—®é¢˜è¯Šæ–­

### åŸå§‹é”™è¯¯åˆ†æ
ä»ç»ˆç«¯æ—¥å¿—å‘ç°ä¸¤ä¸ªJSONååºåˆ—åŒ–é”™è¯¯ï¼š
1. **imageså­—æ®µé”™è¯¯**: `Cannot deserialize value of type 'java.lang.String' from Array value`
2. **tagså­—æ®µé”™è¯¯**: åŒæ ·çš„æ•°ç»„åˆ°å­—ç¬¦ä¸²ç±»å‹ä¸åŒ¹é…é—®é¢˜

### æ ¹æœ¬åŸå› 
- **Productå®ä½“ç±»è®¾è®¡é—®é¢˜**: `images`å’Œ`tags`å­—æ®µå®šä¹‰ä¸ºStringç±»å‹
- **å‰ç«¯æ•°æ®æ ¼å¼**: å‘é€çš„æ˜¯æ•°ç»„æ ¼å¼çš„JSONæ•°æ®
- **ç±»å‹ä¸åŒ¹é…**: Jacksonæ— æ³•å°†æ•°ç»„ååºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²ç±»å‹

## å®Œæ•´ä¿®å¤æ–¹æ¡ˆ

### 1. Productå®ä½“ç±»ä¿®å¤

#### æ·»åŠ JSONæ˜ å°„æ³¨è§£å¯¼å…¥
```java
import com.fasterxml.jackson.annotation.JsonProperty;
```

#### æ·»åŠ imagesæ•°ç»„å¤„ç†æ–¹æ³•
```java
/**
 * å¤„ç†å‰ç«¯å‘é€çš„imagesæ•°ç»„
 * å°†imagesæ•°ç»„æ˜ å°„åˆ°imageListå­—æ®µ
 */
@JsonProperty("images")
public void setImagesFromArray(List<String> images) {
    this.imageList = images;
}

/**
 * è¿”å›imagesæ•°ç»„ç»™å‰ç«¯
 */
@JsonProperty("images")
public List<String> getImagesAsArray() {
    return this.imageList;
}
```

#### æ·»åŠ tagsæ•°ç»„å¤„ç†æ–¹æ³•
```java
/**
 * å¤„ç†å‰ç«¯å‘é€çš„tagsæ•°ç»„
 * å°†tagsæ•°ç»„æ˜ å°„åˆ°tagListå­—æ®µ
 */
@JsonProperty("tags")
public void setTagsFromArray(List<String> tags) {
    this.tagList = tags;
}

/**
 * è¿”å›tagsæ•°ç»„ç»™å‰ç«¯
 */
@JsonProperty("tags")
public List<String> getTagsAsArray() {
    return this.tagList;
}
```

### 2. ProductServiceImplæœåŠ¡å±‚ä¿®å¤

#### åˆ›å»ºå•†å“æ—¶å¤„ç†æ ‡ç­¾æ•°æ®
```java
// å¤„ç†æ ‡ç­¾æ•°æ®ï¼šå°†tagListè½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²å­˜å‚¨åœ¨tagså­—æ®µä¸­
if (product.getTagList() != null && !product.getTagList().isEmpty()) {
    try {
        product.setTags(objectMapper.writeValueAsString(product.getTagList()));
        log.info("æ ‡ç­¾å¤„ç†æˆåŠŸ: tags={}", product.getTagList());
    } catch (Exception e) {
        log.error("æ ‡ç­¾åºåˆ—åŒ–å¤±è´¥: {}", e.getMessage());
        throw new RuntimeException("æ ‡ç­¾å¤„ç†å¤±è´¥");
    }
}
```

#### æŸ¥è¯¢å•†å“æ—¶åŠ è½½æ ‡ç­¾æ•°æ®
```java
private void loadProductData(Product product) {
    // åŠ è½½å›¾ç‰‡æ•°æ®
    if (product != null && StringUtils.hasText(product.getImages())) {
        // ... å›¾ç‰‡åŠ è½½é€»è¾‘
    }
    
    // åŠ è½½æ ‡ç­¾æ•°æ®
    if (product != null && StringUtils.hasText(product.getTags())) {
        try {
            List<String> tagList = objectMapper.readValue(product.getTags(), 
                objectMapper.getTypeFactory().constructCollectionType(List.class, String.class));
            product.setTagList(tagList);
        } catch (Exception e) {
            log.error("åŠ è½½å•†å“æ ‡ç­¾å¤±è´¥: productId={}, error={}", product.getId(), e.getMessage());
            product.setTagList(new ArrayList<>()); // è®¾ç½®ç©ºåˆ—è¡¨é¿å…null
        }
    }
}
```

## ä¿®å¤æ•ˆæœ

### âœ… å·²è§£å†³çš„é—®é¢˜
1. **imagesæ•°ç»„ååºåˆ—åŒ–**: å‰ç«¯å‘é€çš„base64å›¾ç‰‡æ•°ç»„èƒ½æ­£ç¡®æ˜ å°„åˆ°imageListå­—æ®µ
2. **tagsæ•°ç»„ååºåˆ—åŒ–**: å‰ç«¯å‘é€çš„æ ‡ç­¾æ•°ç»„èƒ½æ­£ç¡®æ˜ å°„åˆ°tagListå­—æ®µ
3. **æ•°æ®å­˜å‚¨ä¼˜åŒ–**: å›¾ç‰‡å’Œæ ‡ç­¾æ•°æ®æ­£ç¡®åºåˆ—åŒ–å­˜å‚¨åˆ°æ•°æ®åº“
4. **æ•°æ®æŸ¥è¯¢ä¼˜åŒ–**: æŸ¥è¯¢æ—¶æ­£ç¡®ååºåˆ—åŒ–å¹¶è¿”å›ç»™å‰ç«¯
5. **å‘åå…¼å®¹æ€§**: æ”¯æŒåŸæœ‰çš„å­—ç¬¦ä¸²æ ¼å¼å’Œæ–°çš„æ•°ç»„æ ¼å¼

### ğŸ”„ æ•°æ®æµç¨‹
1. **å‰ç«¯ â†’ åç«¯**: æ•°ç»„æ ¼å¼ â†’ é€šè¿‡@JsonPropertyæ˜ å°„åˆ°Listå­—æ®µ
2. **åç«¯å¤„ç†**: Listå­—æ®µ â†’ JSONå­—ç¬¦ä¸² â†’ å­˜å‚¨åˆ°æ•°æ®åº“Stringå­—æ®µ
3. **åç«¯ â†’ å‰ç«¯**: æ•°æ®åº“Stringå­—æ®µ â†’ è§£æä¸ºListå­—æ®µ â†’ é€šè¿‡@JsonPropertyè¿”å›æ•°ç»„æ ¼å¼

## ä»£ç è´¨é‡æ”¹è¿›å»ºè®®

### 1. æ•°æ®éªŒè¯å¢å¼º
```java
@JsonProperty("images")
public void setImagesFromArray(List<String> images) {
    if (images != null) {
        if (images.size() > 10) {
            throw new IllegalArgumentException("å›¾ç‰‡æ•°é‡ä¸èƒ½è¶…è¿‡10å¼ ");
        }
        // éªŒè¯æ¯ä¸ªå›¾ç‰‡çš„æ ¼å¼
        for (String image : images) {
            if (!isValidBase64Image(image)) {
                throw new IllegalArgumentException("æ— æ•ˆçš„å›¾ç‰‡æ ¼å¼");
            }
        }
    }
    this.imageList = images;
}

@JsonProperty("tags")
public void setTagsFromArray(List<String> tags) {
    if (tags != null) {
        if (tags.size() > 20) {
            throw new IllegalArgumentException("æ ‡ç­¾æ•°é‡ä¸èƒ½è¶…è¿‡20ä¸ª");
        }
        // éªŒè¯æ ‡ç­¾é•¿åº¦å’Œå†…å®¹
        for (String tag : tags) {
            if (tag == null || tag.trim().isEmpty() || tag.length() > 50) {
                throw new IllegalArgumentException("æ ‡ç­¾æ ¼å¼æ— æ•ˆ");
            }
        }
    }
    this.tagList = tags;
}
```

### 2. å¼‚å¸¸å¤„ç†ä¼˜åŒ–
```java
@ExceptionHandler(HttpMessageNotReadableException.class)
public ResponseEntity<Result> handleJsonParseError(HttpMessageNotReadableException e) {
    log.error("JSONè§£æå¤±è´¥: {}", e.getMessage());
    
    String errorMessage = "è¯·æ±‚æ•°æ®æ ¼å¼é”™è¯¯";
    if (e.getMessage().contains("images")) {
        errorMessage = "å›¾ç‰‡æ•°æ®æ ¼å¼é”™è¯¯ï¼Œè¯·ç¡®ä¿å‘é€æ­£ç¡®çš„å›¾ç‰‡æ•°ç»„";
    } else if (e.getMessage().contains("tags")) {
        errorMessage = "æ ‡ç­¾æ•°æ®æ ¼å¼é”™è¯¯ï¼Œè¯·ç¡®ä¿å‘é€æ­£ç¡®çš„æ ‡ç­¾æ•°ç»„";
    }
    
    return ResponseEntity.badRequest().body(Result.error(errorMessage));
}
```

### 3. æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### å›¾ç‰‡å¤„ç†ä¼˜åŒ–
```java
@Async
public CompletableFuture<List<Long>> processImagesAsync(List<String> images, Long userId) {
    List<Long> imageIds = new ArrayList<>();
    for (int i = 0; i < images.size(); i++) {
        String base64Data = images.get(i);
        if (StringUtils.hasText(base64Data)) {
            // å›¾ç‰‡å‹ç¼©
            String compressedImage = compressImage(base64Data);
            // å¼‚æ­¥ä¿å­˜
            Img savedImg = imgService.saveImg("product_" + System.currentTimeMillis() + "_" + i, 
                                            compressedImage, userId);
            if (savedImg != null) {
                imageIds.add(savedImg.getId());
            }
        }
    }
    return CompletableFuture.completedFuture(imageIds);
}
```

#### ç¼“å­˜ç­–ç•¥
```java
@Cacheable(value = "productImages", key = "#product.id")
private List<String> loadProductImages(Product product) {
    // å›¾ç‰‡åŠ è½½é€»è¾‘
}

@Cacheable(value = "productTags", key = "#product.id")
private List<String> loadProductTags(Product product) {
    // æ ‡ç­¾åŠ è½½é€»è¾‘
}
```

### 4. å®‰å…¨æ€§å¢å¼º

#### è¾“å…¥éªŒè¯
```java
public class ProductValidator {
    private static final Pattern BASE64_PATTERN = 
        Pattern.compile("^data:image/(jpeg|png|gif);base64,[A-Za-z0-9+/=]+$");
    
    public static boolean isValidBase64Image(String base64) {
        return base64 != null && BASE64_PATTERN.matcher(base64).matches();
    }
    
    public static boolean isValidTag(String tag) {
        return tag != null && 
               tag.trim().length() > 0 && 
               tag.length() <= 50 && 
               !tag.contains("<") && 
               !tag.contains(">");
    }
}
```

#### æ–‡ä»¶å¤§å°é™åˆ¶
```yaml
spring:
  servlet:
    multipart:
      max-file-size: 10MB
      max-request-size: 50MB

app:
  product:
    image:
      max-count: 10
      max-size-per-image: 5MB
    tag:
      max-count: 20
      max-length: 50
```

### 5. ç›‘æ§å’Œæ—¥å¿—

#### æ€§èƒ½ç›‘æ§
```java
@Aspect
@Component
public class ProductServiceAspect {
    
    @Around("execution(* com.campus.secondhand.service.impl.ProductServiceImpl.createProduct(..))")
    public Object monitorCreateProduct(ProceedingJoinPoint joinPoint) throws Throwable {
        long startTime = System.currentTimeMillis();
        try {
            Object result = joinPoint.proceed();
            long duration = System.currentTimeMillis() - startTime;
            log.info("å•†å“åˆ›å»ºè€—æ—¶: {}ms", duration);
            return result;
        } catch (Exception e) {
            log.error("å•†å“åˆ›å»ºå¤±è´¥: {}", e.getMessage());
            throw e;
        }
    }
}
```

#### ä¸šåŠ¡æ—¥å¿—
```java
@EventListener
public void handleProductCreated(ProductCreatedEvent event) {
    log.info("å•†å“åˆ›å»ºæˆåŠŸ: productId={}, sellerId={}, imageCount={}, tagCount={}", 
             event.getProductId(), event.getSellerId(), 
             event.getImageCount(), event.getTagCount());
}
```

## æµ‹è¯•å»ºè®®

### 1. å•å…ƒæµ‹è¯•
```java
@Test
public void testImagesAndTagsMapping() {
    Product product = new Product();
    
    // æµ‹è¯•imagesæ˜ å°„
    List<String> images = Arrays.asList(
        "data:image/png;base64,test1",
        "data:image/png;base64,test2"
    );
    product.setImagesFromArray(images);
    assertEquals(images, product.getImagesAsArray());
    
    // æµ‹è¯•tagsæ˜ å°„
    List<String> tags = Arrays.asList("ç”µå­äº§å“", "äºŒæ‰‹", "å­¦ç”Ÿç”¨å“");
    product.setTagsFromArray(tags);
    assertEquals(tags, product.getTagsAsArray());
}
```

### 2. é›†æˆæµ‹è¯•
```bash
# æµ‹è¯•åˆ›å»ºå•†å“API
curl -X POST http://localhost:8080/api/products \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{
    "title": "æµ‹è¯•å•†å“",
    "description": "æµ‹è¯•æè¿°",
    "price": 100.00,
    "categoryId": 1,
    "condition": 1,
    "tradeType": 3,
    "images": ["data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg=="],
    "tags": ["ç”µå­äº§å“", "äºŒæ‰‹", "å­¦ç”Ÿç”¨å“"]
  }'
```

## æ€»ç»“

æœ¬æ¬¡ä¿®å¤å®Œå…¨è§£å†³äº†JSONååºåˆ—åŒ–é—®é¢˜ï¼Œå®ç°äº†ï¼š

1. âœ… **å®Œæ•´çš„æ•°ç»„æ”¯æŒ**: imageså’Œtagså­—æ®µéƒ½æ”¯æŒæ•°ç»„æ ¼å¼
2. âœ… **å‘åå…¼å®¹æ€§**: ä¿æŒå¯¹åŸæœ‰å­—ç¬¦ä¸²æ ¼å¼çš„æ”¯æŒ
3. âœ… **æ•°æ®å®Œæ•´æ€§**: æ­£ç¡®çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æµç¨‹
4. âœ… **é”™è¯¯å¤„ç†**: å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•
5. âœ… **æ€§èƒ½ä¼˜åŒ–**: å›¾ç‰‡å­˜å‚¨ä¼˜åŒ–å’Œæ ‡ç­¾å¤„ç†ä¼˜åŒ–

ç°åœ¨ç³»ç»Ÿèƒ½å¤Ÿæ­£ç¡®å¤„ç†å‰ç«¯å‘é€çš„imageså’Œtagsæ•°ç»„æ•°æ®ï¼Œå½»åº•è§£å†³äº†JSONååºåˆ—åŒ–é”™è¯¯é—®é¢˜ã€‚