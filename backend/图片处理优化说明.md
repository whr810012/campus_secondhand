# 图片处理优化说明

## 优化内容

### 1. 数据库设计优化
- **原方案**: 商品表的 `images` 字段直接存储 base64 图片数据的 JSON 数组
- **新方案**: 
  - 图片数据存储在 `imgs` 表中，包含 `id`、`name`、`base64_data`、`user_id` 等字段
  - 商品表的 `images` 字段存储图片 ID 的 JSON 数组

### 2. 优势
- **存储优化**: 避免重复存储相同图片
- **查询性能**: 可以按需加载图片数据
- **数据管理**: 便于图片的统一管理和维护
- **扩展性**: 支持图片的更多属性（状态、创建时间等）

## 实现细节

### 后端修改

1. **ProductServiceImpl.createProduct()** 方法优化:
   - 接收前端发送的 base64 图片数组
   - 将每张图片保存到 `imgs` 表
   - 将图片 ID 集合存储到商品的 `images` 字段

2. **图片加载逻辑**:
   - 在查询商品时，根据 `images` 字段中的 ID 集合
   - 从 `imgs` 表中获取对应的 base64 数据
   - 设置到 `imageList` 字段供前端使用

### 兼容性处理
- 支持前端发送的两种格式:
  - `imageList` 字段（数组格式）
  - `images` 字段（JSON 字符串格式）
- 向后兼容旧的数据格式

## 测试建议

1. **创建商品测试**:
   ```bash
   POST http://localhost:8080/api/products
   Content-Type: application/json
   Authorization: Bearer <your-token>
   
   {
     "title": "测试商品",
     "description": "测试描述",
     "price": 100.00,
     "categoryId": 1,
     "condition": 1,
     "tradeType": 3,
     "images": ["data:image/jpeg;base64,/9j/4AAQ...", "data:image/png;base64,iVBORw0KGgo..."]
   }
   ```

2. **查询商品测试**:
   ```bash
   GET http://localhost:8080/api/products/{id}
   ```
   
   验证返回的商品数据中 `imageList` 字段包含正确的 base64 数据。

## 数据库变更

`imgs` 表已存在，结构如下:
```sql
CREATE TABLE `imgs` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '图片ID',
  `name` varchar(255) NOT NULL COMMENT '图片名称',
  `base64_data` longtext NOT NULL COMMENT '图片base64数据',
  `user_id` bigint(20) NOT NULL COMMENT '上传用户ID',
  `status` tinyint(1) DEFAULT 1 COMMENT '状态：0-删除，1-正常',
  `created_at` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='图片表';
```

## 注意事项

1. **事务处理**: 商品创建和图片保存在同一事务中，确保数据一致性
2. **错误处理**: 图片保存失败时会回滚整个商品创建操作
3. **性能考虑**: 大量图片查询时可能需要进一步优化（如缓存、分页加载等）
4. **存储空间**: base64 编码会增加约 33% 的存储空间，考虑后续优化为文件存储